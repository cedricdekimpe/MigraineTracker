<% content_for :title, t('migraines.history_title') %>

<section class="mx-auto w-full max-w-4xl">
  <header class="mb-6">
    <h1 class="text-2xl font-semibold text-slate-900"><%= t('migraines.history_title') %></h1>
    <p class="mt-2 text-sm text-slate-500"><%= t('migraines.history_description') %></p>
  </header>

  <%# Year Filter %>
  <% if @years.any? %>
    <div class="mb-6 flex flex-wrap items-center gap-3">
      <span class="text-sm font-medium text-slate-700"><%= t('migraines.filter_by_year') %>:</span>
      <%= link_to t('migraines.all_years'), history_migraines_path, 
          class: "rounded-md px-3 py-1.5 text-sm font-medium transition #{@selected_year.nil? ? 'bg-emerald-600 text-white' : 'bg-slate-100 text-slate-700 hover:bg-slate-200'}" %>
      <% @years.each do |year| %>
        <%= link_to year, history_migraines_path(year: year), 
            class: "rounded-md px-3 py-1.5 text-sm font-medium transition #{@selected_year == year ? 'bg-emerald-600 text-white' : 'bg-slate-100 text-slate-700 hover:bg-slate-200'}" %>
      <% end %>
    </div>
  <% end %>

  <% if @migraines.any? %>
    <div class="rounded-xl border border-slate-200 bg-white shadow-sm overflow-hidden">
      <%# Desktop Table View %>
      <div class="hidden md:block">
        <table class="w-full">
          <thead class="border-b border-slate-200 bg-slate-50">
            <tr>
              <th class="px-4 py-3 text-left text-xs font-semibold uppercase tracking-wider text-slate-600"><%= t('migraines.date') %></th>
              <th class="px-4 py-3 text-left text-xs font-semibold uppercase tracking-wider text-slate-600"><%= t('migraines.nature') %></th>
              <th class="px-4 py-3 text-center text-xs font-semibold uppercase tracking-wider text-slate-600"><%= t('migraines.intensity') %></th>
              <th class="px-4 py-3 text-center text-xs font-semibold uppercase tracking-wider text-slate-600"><%= t('migraines.on_period') %></th>
              <th class="px-4 py-3 text-left text-xs font-semibold uppercase tracking-wider text-slate-600"><%= t('migraines.medication') %></th>
              <th class="px-4 py-3 text-right text-xs font-semibold uppercase tracking-wider text-slate-600"><%= t('migraines.actions') %></th>
            </tr>
          </thead>
          <tbody class="divide-y divide-slate-200">
            <% @migraines.each do |migraine| %>
              <tr class="hover:bg-slate-50 transition">
                <td class="px-4 py-3 text-sm font-medium text-slate-900">
                  <%= l(migraine.occurred_on, format: :long) %>
                </td>
                <td class="px-4 py-3 text-sm text-slate-600">
                  <%= t("migraine_nature.#{migraine.nature}") %>
                </td>
                <td class="px-4 py-3 text-center">
                  <span class="inline-flex items-center justify-center rounded-full px-2.5 py-0.5 text-xs font-medium <%= intensity_color_class(migraine.intensity) %>">
                    <%= migraine.intensity %>/10
                  </span>
                </td>
                <td class="px-4 py-3 text-center">
                  <% if migraine.on_period %>
                    <svg class="mx-auto h-5 w-5 text-rose-500" fill="currentColor" viewBox="0 0 20 20">
                      <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"/>
                    </svg>
                  <% else %>
                    <span class="text-slate-300">—</span>
                  <% end %>
                </td>
                <td class="px-4 py-3 text-sm text-slate-600">
                  <%= migraine.medication&.name || "—" %>
                </td>
                <td class="px-4 py-3 text-right">
                  <div class="flex items-center justify-end gap-2">
                    <%= link_to edit_migraine_path(migraine, year: @selected_year), 
                        class: "rounded-md p-1.5 text-slate-500 transition hover:bg-slate-100 hover:text-emerald-600",
                        title: t('migraines.edit') do %>
                      <svg class="h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"/>
                      </svg>
                    <% end %>
                    <%= button_to migraine_path(migraine, year: @selected_year), 
                        method: :delete, 
                        data: { turbo_confirm: t('migraines.confirm_delete') },
                        class: "rounded-md p-1.5 text-slate-500 transition hover:bg-rose-50 hover:text-rose-600",
                        title: t('migraines.delete'),
                        form: { class: "inline" } do %>
                      <svg class="h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/>
                      </svg>
                    <% end %>
                  </div>
                </td>
              </tr>
            <% end %>
          </tbody>
        </table>
      </div>

      <%# Mobile Card View %>
      <div class="divide-y divide-slate-200 md:hidden">
        <% @migraines.each do |migraine| %>
          <div class="p-4">
            <div class="flex items-start justify-between">
              <div>
                <p class="font-medium text-slate-900"><%= l(migraine.occurred_on, format: :long) %></p>
                <p class="mt-1 text-sm text-slate-600"><%= t("migraine_nature.#{migraine.nature}") %></p>
              </div>
              <span class="inline-flex items-center rounded-full px-2.5 py-0.5 text-xs font-medium <%= intensity_color_class(migraine.intensity) %>">
                <%= migraine.intensity %>/10
              </span>
            </div>
            <div class="mt-3 flex items-center gap-4 text-sm text-slate-500">
              <% if migraine.on_period %>
                <span class="flex items-center gap-1 text-rose-600">
                  <svg class="h-4 w-4" fill="currentColor" viewBox="0 0 20 20">
                    <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"/>
                  </svg>
                  <%= t('migraines.on_period') %>
                </span>
              <% end %>
              <% if migraine.medication %>
                <span><%= migraine.medication.name %></span>
              <% end %>
            </div>
            <div class="mt-3 flex items-center gap-2 border-t border-slate-100 pt-3">
              <%= link_to edit_migraine_path(migraine, year: @selected_year), 
                  class: "flex-1 rounded-md border border-slate-300 bg-white px-3 py-1.5 text-center text-sm font-medium text-slate-700 transition hover:bg-slate-50" do %>
                <%= t('migraines.edit') %>
              <% end %>
              <%= button_to migraine_path(migraine, year: @selected_year), 
                  method: :delete, 
                  data: { turbo_confirm: t('migraines.confirm_delete') },
                  class: "flex-1 rounded-md border border-rose-300 bg-white px-3 py-1.5 text-center text-sm font-medium text-rose-600 transition hover:bg-rose-50" do %>
                <%= t('migraines.delete') %>
              <% end %>
            </div>
          </div>
        <% end %>
      </div>
    </div>

    <%# Pagination %>
    <% if @pagy.pages > 1 %>
      <div class="mt-6">
        <%== pagy_tailwind_nav(@pagy) %>
      </div>
    <% end %>
  <% else %>
    <%# Empty State %>
    <div class="rounded-xl border border-dashed border-slate-300 bg-white px-6 py-12 text-center">
      <svg class="mx-auto h-12 w-12 text-slate-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"/>
      </svg>
      <h3 class="mt-4 text-lg font-medium text-slate-900"><%= t('migraines.no_history') %></h3>
      <p class="mt-2 text-sm text-slate-500"><%= t('migraines.no_history_hint') %></p>
      <%= link_to t('migraines.new_entry'), new_migraine_path, 
          class: "mt-4 inline-flex items-center rounded-md bg-emerald-600 px-4 py-2 text-sm font-semibold text-white transition hover:bg-emerald-700" %>
    </div>
  <% end %>
</section>
